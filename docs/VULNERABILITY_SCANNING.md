# Dependency Vulnerability Scanning

## Overview

The repo-analysis-system includes automated dependency vulnerability scanning to identify known security issues in your project dependencies across multiple languages.

## Supported Languages

- **Python**: requirements.txt, pyproject.toml
- **JavaScript/Node.js**: package.json
- **Rust**: Cargo.toml

## Features

### Vulnerability Detection

The scanner queries the [OSV (Open Source Vulnerabilities)](https://osv.dev/) database to identify:

- **CVE IDs**: Common Vulnerabilities and Exposures identifiers
- **GitHub Security Advisories**: GHSA identifiers
- **Severity Levels**: Critical, High, Medium, Low
- **CVSS Scores**: Common Vulnerability Scoring System scores
- **Fix Recommendations**: Available patches and version upgrades

### Severity Classification

Vulnerabilities are classified using CVSS scores:

- **Critical**: CVSS ≥ 9.0
- **High**: CVSS ≥ 7.0
- **Medium**: CVSS ≥ 4.0
- **Low**: CVSS > 0
- **Unknown**: No CVSS score available

## Usage

### Standalone Scanning

```python
from src.security.vulnerability_scanner import VulnerabilityScanner

# Initialize scanner
scanner = VulnerabilityScanner()

# Scan repository
report = scanner.scan_repository("path/to/repo")

# Access summary
print(f"Total vulnerabilities: {report.summary['total_vulnerabilities']}")
print(f"Critical: {report.summary['critical']}")
print(f"High: {report.summary['high']}")
print(f"Medium: {report.summary['medium']}")
print(f"Low: {report.summary['low']}")

# Review vulnerabilities
for vuln in report.vulnerabilities:
    print(f"\n{vuln.vulnerability_id}: {vuln.title}")
    print(f"Package: {vuln.package_name} v{vuln.installed_version}")
    print(f"Severity: {vuln.severity.value}")
    print(f"Fix: {vuln.fix_recommendation}")
```

### Integrated with LangGraph Workflow

Vulnerability scanning runs automatically as part of the repository analysis:

```bash
python scripts/run_graph.py analyze --repos "owner/repo" --user-id 1
```

Results are:
- Stored as pain points with type "security_vulnerability"
- Included in analysis reports
- Prioritized by severity

## Output Format

### VulnerabilityReport Structure

```json
{
  "summary": {
    "total_vulnerabilities": 5,
    "critical": 1,
    "high": 2,
    "medium": 1,
    "low": 1,
    "unknown": 0
  },
  "total_scanned": 45,
  "scan_timestamp": "2025-01-15T10:30:00Z",
  "scanned_files": [
    "/path/to/requirements.txt",
    "/path/to/package.json",
    "/path/to/Cargo.toml"
  ],
  "vulnerabilities": [
    {
      "package_name": "requests",
      "installed_version": "2.25.0",
      "vulnerability_id": "CVE-2023-32681",
      "severity": "HIGH",
      "title": "Unintended leak of Proxy-Authorization header",
      "description": "Requests library versions prior to 2.31.0 leak Proxy-Authorization headers...",
      "affected_versions": "< 2.31.0",
      "fixed_version": "2.31.0",
      "published_date": "2023-05-26T00:00:00Z",
      "references": [
        "https://github.com/psf/requests/security/advisories/GHSA-j8r2-6x86-q33q",
        "https://nvd.nist.gov/vuln/detail/CVE-2023-32681"
      ],
      "cvss_score": 7.5
    }
  ]
}
```

### Vulnerability Object

Each vulnerability includes:

- `package_name`: Affected package
- `installed_version`: Currently installed version
- `vulnerability_id`: CVE or GHSA identifier
- `severity`: CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN
- `title`: Brief description
- `description`: Detailed explanation
- `affected_versions`: Version range affected
- `fixed_version`: Version with the fix (if available)
- `published_date`: When vulnerability was disclosed
- `references`: Links to advisories and documentation
- `cvss_score`: CVSS score (if available)

## Data Sources

### OSV Database

The primary data source is the [Open Source Vulnerabilities (OSV)](https://osv.dev/) database, which aggregates:

- **NVD** (National Vulnerability Database)
- **GitHub Advisory Database**
- **Python Package Index (PyPI) Advisories**
- **npm Security Advisories**
- **RustSec Advisory Database**
- And many more...

### API Rate Limits

The OSV API has rate limits:
- Default: 100 requests/minute
- The scanner handles rate limiting gracefully

## Fix Recommendations

The scanner automatically generates actionable fix recommendations:

```python
vuln = report.vulnerabilities[0]
print(vuln.fix_recommendation)
# Output: "Upgrade requests from 2.25.0 to 2.31.0"
```

If no fix is available:
```
"No fix available yet for package-name. Monitor CVE-2023-XXXXX for updates."
```

## Integration Examples

### CI/CD Integration

Fail builds based on vulnerability severity:

```python
report = scanner.scan_repository(".")

# Fail on critical vulnerabilities
if report.summary['critical'] > 0:
    print(f"Found {report.summary['critical']} critical vulnerabilities!")
    exit(1)

# Fail on high or critical
if report.summary['critical'] + report.summary['high'] > 0:
    print("Found high or critical vulnerabilities!")
    exit(1)
```

### Filtering by Severity

```python
# Get only critical vulnerabilities
critical_vulns = report.get_by_severity(Severity.CRITICAL)

for vuln in critical_vulns:
    print(f"URGENT: {vuln.package_name} has {vuln.vulnerability_id}")
    print(f"Fix: {vuln.fix_recommendation}")
```

### Generate Security Report

```python
report = scanner.scan_repository(".")

print("# Security Vulnerability Report\n")
print(f"Scanned {report.total_scanned} packages\n")

for severity in [Severity.CRITICAL, Severity.HIGH, Severity.MEDIUM, Severity.LOW]:
    vulns = report.get_by_severity(severity)
    if vulns:
        print(f"\n## {severity.value} Severity ({len(vulns)})\n")
        for vuln in vulns:
            print(f"- **{vuln.vulnerability_id}**: {vuln.package_name}@{vuln.installed_version}")
            print(f"  - {vuln.title}")
            print(f"  - Fix: {vuln.fix_recommendation}")
```

## Multi-Language Support

### Python (requirements.txt)

```
requests==2.25.0
flask>=2.0.0
django~=4.0
```

### Python (pyproject.toml)

```toml
[project]
dependencies = [
    "requests>=2.30.0",
    "flask>=2.0.0"
]

[tool.poetry.dependencies]
python = "^3.9"
requests = "^2.30.0"
```

### JavaScript (package.json)

```json
{
  "dependencies": {
    "express": "^4.17.0",
    "lodash": "4.17.20"
  },
  "devDependencies": {
    "jest": "^27.0.0"
  }
}
```

### Rust (Cargo.toml)

```toml
[dependencies]
serde = "1.0"
tokio = { version = "1.0", features = ["full"] }
```

## Best Practices

1. **Scan Regularly**: Run scans on every commit or PR
2. **Prioritize Fixes**: Address CRITICAL and HIGH severity issues first
3. **Monitor Advisories**: Subscribe to security advisories for your dependencies
4. **Keep Dependencies Updated**: Regularly update to latest secure versions
5. **Use Lock Files**: Commit lock files (package-lock.json, Cargo.lock) for reproducibility

## Automation

### Pre-commit Hook

```bash
#!/bin/bash
# .git/hooks/pre-commit

python -c "
from src.security.vulnerability_scanner import VulnerabilityScanner
scanner = VulnerabilityScanner()
report = scanner.scan_repository('.')
if report.summary['critical'] > 0:
    print('❌ Critical vulnerabilities found!')
    exit(1)
"
```

### GitHub Actions

```yaml
name: Security Scan
on: [push, pull_request]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run vulnerability scan
        run: |
          python scripts/run_graph.py analyze --repos "$GITHUB_REPOSITORY"
```

## Limitations

- Requires internet connection to query OSV database
- May have false positives for transitive dependencies
- Fix recommendations assume standard versioning
- API rate limits may affect large monorepos

## Troubleshooting

### No Vulnerabilities Found

If no vulnerabilities are detected but you expect some:
1. Verify dependency files are in standard format
2. Check that package versions are specified (not just ranges)
3. Ensure OSV API is accessible

### Rate Limiting

If you hit OSV API rate limits:
1. Reduce scan frequency
2. Implement caching for results
3. Consider self-hosting OSV database

## References

- [OSV Database](https://osv.dev/)
- [CVE Database](https://cve.mitre.org/)
- [NVD](https://nvd.nist.gov/)
- [GitHub Advisory Database](https://github.com/advisories)
- [CVSS Specification](https://www.first.org/cvss/)
